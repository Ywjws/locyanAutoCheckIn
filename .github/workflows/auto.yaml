name: Auto Sign-In  # è‡ªåŠ¨ç­¾åˆ°
on:
  schedule:
    - cron: '0 8 * * *'  # æ¯å¤©UTCæ—¶é—´8ç‚¹è¿è¡Œ
  workflow_dispatch:

jobs:
  signin:  # ç­¾åˆ°ä»»åŠ¡
    runs-on: ubuntu-latest
    steps:
      - name: Verify and Sign-In  # éªŒè¯å¹¶ç­¾åˆ°
        run: |
          # è·å– secrets
          USER_ID="${{ secrets.USER_ID }}"
          TOKEN="${{ secrets.AUTHORIZATION_TOKEN }}"
          
          # éªŒè¯æ ¼å¼
          echo "ğŸ” Validating credentials..."
          if ! [[ "$USER_ID" =~ ^[0-9]+$ ]]; then
            echo "âŒ USER_ID must be numeric"; exit 1
          fi
          if [[ -z "$TOKEN" ]]; then
            echo "âŒ TOKEN cannot be empty"; exit 1
          fi

          # è°ƒè¯•è¾“å‡º (ä¸æ˜¾ç¤ºæ•æ„Ÿä¿¡æ¯)
          echo "âœ… Credentials validated"
          echo "â„¹ï¸ USER_ID length: ${#USER_ID}"
          echo "â„¹ï¸ TOKEN length: ${#TOKEN}"

          # å‘é€è¯·æ±‚
          echo "ğŸ“¡ Calling API..."
          response=$(curl -sSv -X POST \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "user_id=$USER_ID" \
            "https://api.locyanfrp.cn/v2/sign" 2>&1)

          # è§£æå“åº”
          echo "=== Raw Response ==="
          echo "$response" | grep -v "Authorization:"
          
          # æå–JSONéƒ¨åˆ†
          json=$(echo "$response" | grep -E '^{.*}$')
          if [ -z "$json" ]; then
            echo "âŒ Invalid API response"; exit 1
          fi

          # ä½¿ç”¨jqè§£æ
          status=$(echo "$json" | jq -r '.status')
          message=$(echo "$json" | jq -r '.message')
          
          echo "=== Parsed Result ==="
          echo "$json" | jq .
          
          if [ "$status" == "0" ]; then
            echo "ğŸ‰ Sign-in successful!"
            echo "ğŸ”¼ Traffic obtained: $(echo "$json" | jq -r '.data.get_traffic')MB"
          else
            echo "âŒ Failed (Status $status)"
            echo "ğŸ“¢ Error: $message"
            
            # ç‰¹æ®Šå¤„ç†å¸¸è§é”™è¯¯
            if [ "$status" == "401" ]; then
              echo "ğŸ’¡ Solutions:"
              echo "1. Check if AUTHORIZATION_TOKEN is expired"
              echo "2. Confirm correct Token format (no 'Bearer ' prefix)"
              echo "3. Verify account permissions"
            fi
            exit 1
          fi
        env:
          LC_ALL: C.UTF-8
          LANG: C.UTF-8
