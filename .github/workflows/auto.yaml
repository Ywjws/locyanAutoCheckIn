name: è‡ªåŠ¨ç­¾åˆ°
on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  ç­¾åˆ°:
    runs-on: ubuntu-latest
    steps:
      - name: æ‰§è¡Œç­¾åˆ°
        run: |
          # è·å– secrets
          USER_ID="${{ secrets.USER_ID }}"
          TOKEN="${{ secrets.AUTHORIZATION_TOKEN }}"
          
          # éªŒè¯æ ¼å¼
          echo "ğŸ” éªŒè¯å‡­æ®æ ¼å¼..."
          if ! [[ "$USER_ID" =~ ^[0-9]+$ ]]; then
            echo "âŒ USER_ID å¿…é¡»ä¸ºçº¯æ•°å­—"; exit 1
          fi
          if [[ -z "$TOKEN" ]]; then
            echo "âŒ TOKEN ä¸èƒ½ä¸ºç©º"; exit 1
          fi

          # è°ƒè¯•è¾“å‡º (ä¸æ˜¾ç¤ºæ•æ„Ÿä¿¡æ¯)
          echo "âœ… å‡­æ®æ ¼å¼æœ‰æ•ˆ"
          echo "â„¹ï¸ USER_ID é•¿åº¦: ${#USER_ID}"
          echo "â„¹ï¸ TOKEN é•¿åº¦: ${#TOKEN}"

          # å‘é€è¯·æ±‚
          echo "ğŸ“¡ æ­£åœ¨è¯·æ±‚API..."
          response=$(curl -sSv -X POST \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "user_id=$USER_ID" \
            "https://api.locyanfrp.cn/v2/sign" 2>&1)

          # è§£æå“åº”
          echo "=== åŸå§‹å“åº” ==="
          echo "$response" | grep -v "Authorization:"
          
          # æå–JSONéƒ¨åˆ†
          json=$(echo "$response" | grep -E '^{.*}$')
          if [ -z "$json" ]; then
            echo "âŒ æ— æ•ˆçš„APIå“åº”"; exit 1
          fi

          # ä½¿ç”¨jqè§£æ
          status=$(echo "$json" | jq -r '.status')
          message=$(echo "$json" | jq -r '.message')
          
          echo "=== è§£æç»“æœ ==="
          echo "$json" | jq .
          
          if [ "$status" == "0" ]; then
            echo "ğŸ‰ ç­¾åˆ°æˆåŠŸï¼"
            echo "ğŸ”¼ è·å¾—æµé‡: $(echo "$json" | jq -r '.data.get_traffic')MB"
          else
            echo "âŒ å¤±è´¥ (çŠ¶æ€ç  $status)"
            echo "ğŸ“¢ é”™è¯¯ä¿¡æ¯: $message"
            
            # ç‰¹æ®Šå¤„ç†å¸¸è§é”™è¯¯
            if [ "$status" == "401" ]; then
              echo "ğŸ’¡ è§£å†³æ–¹æ¡ˆ:"
              echo "1. æ£€æŸ¥ AUTHORIZATION_TOKEN æ˜¯å¦è¿‡æœŸ"
              echo "2. ç¡®è®¤Tokenæ ¼å¼æ­£ç¡® (ä¸éœ€è¦åŒ…å« 'Bearer ' å‰ç¼€)"
              echo "3. ç¡®ä¿Tokenæœ‰ç­¾åˆ°æƒé™"
            fi
            exit 1
          fi
        env:
          LC_ALL: C.UTF-8
          LANG: C.UTF-8
